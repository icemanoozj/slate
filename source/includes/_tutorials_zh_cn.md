# 2. Tutorials


## 2.1 First Call

请先阅读接口指导说明，我们在本节将给出UMF接口整体调用关系图，可以根据需要查看具体接口。

测试

<div class="mermaid">
sequenceDiagram
　　　participant 商户
　　　participant UMF
　　　商户\-\->>UMF:向UMF发起业务开通申请（提交公司材料供UMF审核）
　　　Note right of UMF:UMF审核通过后，为商户开通联调环境，分配：client_id、client_secret
　　　UMF\-\->>商户:告知client_id、client_secret
     商户\-\->>UMF: 获取Access Token
　　　UMF\-\->>商户: 返回access_token
      Note right of 商户:商户使用token调用后续接口
</div>

调用UMF REST请求说明:

* Get an access token
* Make an API call

### [Get an access token](#1-5-get-an-access-token)

Make a /oauth/authorize call with your app's OAuth client_id and secret keys for the basic authentication values. In the request body, set grant_type to client_credentials. When you run the command, UMF generates and returns an access token.

For information about the request headers, see REST API authentication and headers.

<aside class="notice">
Note: The access token is valid for the number of seconds specified in the expires_in response field. You must have a valid access token to make API requests—request a new token when the current one expires.
</aside>

### Make an API call

With a valid access token in hand, you're ready to make a request to a REST interface.

The access token is an OAuth bearer token and is included in the header of your requests with the following syntax:

>Authorization: Bearer Access-Token

For details on authentication, see [Authentication](#1-2-authentication).

## 2.2 Pay by bank card of Union pay

UMF支持商户使用[15个不同的币种](#currency-codes)发起收款，消费者可以使用中国发行的信用卡或借记卡进行支付。商户与UMF交互流程如下图：

<div class="mermaid">
sequenceDiagram
　　　participant 用户
　　　participant 商户
　　　participant UMF
　　　participant 银行
　　　用户\-\->>商户:1.选购商品
　　　商户\-\->>用户:2.生成订单 
　　　用户\-\->>商户:3.确认购买
　　　商户\-\->>UMF: 3.1.获取Access Token
　　　UMF\-\->>商户: 3.2.返回access_token
　　　Note right of UMF:商户使用token调用后续接口
　　　商户\-\->>UMF: 4.请求下单
　　　UMF\-\->>商户:5.返回下单结果，并返回可以使用的支付方式
　　　Note right of UMF:对于银行卡支付，商户如果需要为用户展示可以使用的银行卡，调用，获取银行卡列表接口  
　　　商户\-\->>UMF:5.1获取银行列表
　　　UMF\-\->>商户:5.2支持的银行卡列表
　　　Note right of UMF:可查询的卡种为：CREDIT_CARD, DEBIT_CARD
　　　商户\-\->>用户:6.展示支持的银行卡列表，展示支付页面
　　　用户\-\->>商户:7.选择用于支付的银行卡，填写支付信息，获取短信验证码
　　　商户\-\->>UMF: 8.请求下发短信
　　　UMF\-\->>用户:9.下发短信
　　　用户\-\->>商户:10.填写验证码，确认支付
　　　商户\-\->>UMF: 11.请求支付   
　　　UMF\-\->>银行:12.请求扣款     
　　　银行\-\->>UMF:13.扣款结果
　　　UMF\-\->>商户:14.支付结果
　　　商户\-\->>用户:15.支付结果 
</div>

流程说明：

1.用户在商户平台选购商品

2.商户为用户生成订单

3.用户确认购买订单商品

3.1.商户请求UMF获取Access Token,详见 [Get an access token](#1-5-get-an-access-token)

3.1.UMF返回access_token

4.商户平台提交订单数据到联动优势平台 **请求下单**，调用 [Create a payment](#3-3-create-a-payment)

5.联动平台响应商户下单结果

5.1.商户请求UMF获取银行卡列表 [Query available banks](#3-2-query-available-banks)

5.2.UMF返回支持的银行卡列表

6.商户向用户展现支付页面

7.用户填写手机号码，获取短信验证码

8.商户调用联动平台接口，**请求下发短信验证码**，调用 [SMS verification](#3-4-sms-verification)

9.联动平台向用户下发短信

10.用户在商户端填写支付要素信息，提交信息进行支付

11.商户向平台**请求支付**，调用 [Execute a payment](#3-5-execute-a-payment)      

12.平台向银行发起扣款请求

13.联动平台接收银行的扣款结果

14.联动平台响应商户支付结果

15.商户向用户展现支付结果

## 2.3 Pay by WeChat/Alipay QR Code Payment

UMF return a QR-Code String. The customer may use their WeChat scan the QR-Code to pay.

**It will be released in June 2017.**

<div class="mermaid">
sequenceDiagram
    participant Customer
    participant Merchant
    participant UMF
    participant WeChat/Alipay
    Customer\-\->>Merchant: 1. Order goods
    Merchant\-\->>Customer: 2. Generate order
    Customer\-\->>Merchant: 3. Confirm order
    Note right of Merchant: If the merchant have an unexpired access token. It can be used to make an API call
    Merchant\-\->>UMF: 4. Optional. Acquire an access token
    UMF\-\->>Merchant: 5. Return access_token
    Note right of Merchant:  Using access token to make API call
    Merchant\-\->>UMF: 6. Create a payment
    UMF\-\->>WeChat/Alipay: 7. Payment request
    WeChat/Alipay\-\->>UMF: 8. Return an URL of QR code
    UMF\-\->>Merchant: 9. Return an ali_qr_scan object
    Merchant\-\->>Customer: 10. Show the page of QR code which generated by the URL
    Customer\-\->>WeChat/Alipay: 11. Finish the payment by scanning QR code
    WeChat/Alipay\-\->>UMF: 12. Deduction result
    UMF\-\->>Merchant: 13. Payment result notification
    Merchant\-\->>Customer: 14. Payment result
    
</div>

Explanation of the sequence chart：

1. Customer orders goods at merchant platform.
1. Merchant generate an order.
1. Customer confirm the order.
1. Optional. Merchant [acquire an access token](#1-5-get-an-access-token). This step is optional. If the merchant have an unexpired access_token already, This token can be used to make a API call. Please ignore step 4 and setp 5.
1. UMF returns an access token.
1. Merchant submit order data to UMF. Call [Create a payment](#3-2-create-a-payment).
1. UMF sends a payment request to WeChat/Alipay.
1. WeChat/Alipay returns an URL of QR code to UMF.
1. UMF returns an ali_qr_scan object.
1. Merchant show the page of QR code to customer.
1. Customer finish the payment by scaning QR code.
1. UMF receives the result of deduction.
1. UMF [sends the payment result notification](#3-5-payment-result-notification) to merchant.
1. Merchant shows the result to customer.

## 2.4 Pay by Wechat pay in Apps

Merchants push product messages to their followers via Official Account. With WeChat Pay enabled, their followers can purchase products on the shopping page.

**It will be released in June 2017.**

<div class="mermaid">
sequenceDiagram
    participant Customer
    participant WeChat Browser
    participant Merchant
    participant UMF
    participant WeChat
    Customer\-\->>Merchant: 1. Order goods
    Merchant\-\->>Customer: 2. Generate order
    Customer\-\->>WeChat Browser: 3. Confirm order with access token
    Note right of WeChat Browser:  Call API with access token
    WeChat Browser\-\->>UMF: 4. Request authorization page(html and javascript)
    UMF\-\->>WeChat Browser: 5. Return autorization page.
    WeChat Browser\-\->>WeChat: 6. Request open_id
    WeChat\-\->>WeChat Browser: 7. Return open_id
    WeChat Browser\-\->>Merchant: 8. Redirect page to notify_url
    Merchant\-\->>WeChat Browser: 9. Return a pending page.
    WeChat Browser\-\->>Merchant: 10. Request wechat pay.
    Merchant\-\->>UMF: 11. Payment request
    UMF\-\->>WeChat: 12. Payment request
    WeChat\-\->>UMF: 13. Return payment info
    UMF\-\->>Merchant: 14. Return a WeChat_in_app_web object
    Merchant\-\->>WeChat Browser: 15. Activate payment widget
    WeChat Browser\-\->>WeChat Browser: 16. Call WeChat JS-API
    Customer\-\->>WeChat: 17. Enter password, finish payment
    WeChat\-\->>WeChat Browser: 18. Return pending info.
    WeChat Browser\-\->>WeChat Browser: 19. Redirect to ret_url.
    WeChat\-\->>UMF: 20. Deduction result.
    UMF\-\->>Merchant: 21. Payment result.
</div>

Explanation of the sequence chart：

1. Customer orders goods at merchant platform.
2. Merchant generates an order.
3. Customer confirms the order.
4. Call the authorization page from UMF.Call [Get WeChat open_id](#3-15-get-wechat-open_id).
5. UMF returns the authorization page.
6. The authorization page requests WeChat open_id. 
7. The WeChat returns the open_id of current WeChat user.
8. The authorization page redirect to notify_url(step 4).
9. **Optional**. The Merchat returns a pending page to wait.
10. **Optional**. The pending page request a payment.
11. Merchant send payment request to UMF.Call [Create a payment](#3-2-create-a-payment).
12. UMF sends payment request to WeChat.
13. WeChat returns payment info to UMF.
14. UMF returns a WeChat_in_app_web object.
15. Merchant returns info with WeChat_in_app_web object to browser.
16. The return page activates Wechat payment widget(WeChat JS-API).
17. Customer enter password and finish the payment in WeChat explore.
18. WeChat return ap pending page.
19. The pending page redirect to ret_url(step 11).
20. WeChat send the payment result to UMF.
21. UMF send the payment result to Merchat.

## 2.5 Refund


## 2.6 Query




